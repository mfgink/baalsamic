<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Baalsamic V9</title>

    <style>
        /* BASE & TYPOGRAPHY */
        body { background: #0d0d0d; color: #ccc; font-family: monospace; padding: 0; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        h1 { color: #ff0055; letter-spacing: 2px; text-transform: uppercase; margin: 20px 0; font-size: 1.5em; text-align: center; }
        
        /* COMMON UI ELEMENTS */
        .btn-action { width: 100%; background: #00ffcc; color: black; border: none; padding: 15px; font-size: 1.2em; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; border-radius: 4px; }
        .btn-secondary { background: #333; color: #ccc; border: 1px solid #555; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 0.9em; }
        
        /* SCREENS */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; box-sizing: border-box; }
        #screen-ingest { display: flex; max-width: 600px; margin: 0 auto; width: 100%; }
        #screen-time-travel { padding: 0; } /* Full screen for editor */

        /* INGEST CONFIG */
        .config-panel { background: #1a1a1a; padding: 15px; border: 1px solid #333; border-radius: 8px; margin-bottom: 20px; text-align: left; }
        .config-label { color: #ff0055; font-weight: bold; display: block; margin-bottom: 8px; font-size: 0.8em; text-transform: uppercase; }
        
        .radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .radio-option { flex: 1; position: relative; }
        .radio-option input { opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; }
        .radio-tile { display: flex; align-items: center; justify-content: center; background: #222; border: 1px solid #444; padding: 12px; border-radius: 4px; transition: 0.2s; }
        .radio-option input:checked + .radio-tile { background: #ff0055; color: white; border-color: #ff0055; }
        
        .upload-input { padding: 15px; background: #222; border: 1px solid #333; color: #eee; width: 100%; box-sizing: border-box; border-radius: 4px; margin-bottom: 20px; }

        /* TIME TRAVEL EDITOR layout */
        .editor-container { display: flex; flex-direction: column; height: 100%; }
        
        /* THE VIEWPORT (The Stage) */
        .viewport-wrapper { 
            flex: 1; 
            background: #000; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
            border-bottom: 1px solid #333;
        }
        
        .teal-frame {
            border: 2px solid #00ffcc;
            width: 96%; /* 2% buffer on each side */
            height: 96%; /* 2% buffer top/bottom */
            position: relative;
            overflow: hidden; /* This creates the "Window" */
            display: flex;
            align-items: center;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.2);
        }

        /* The Scrollable Area inside the Frame */
        .scroll-container {
            width: 100%;
            height: 100%;
            overflow-x: auto; /* Horizontal Scroll */
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            display: flex;
            align-items: center; /* Vertically center the image */
        }
        
        /* The Actual Glitch Image */
        #main_canvas {
            height: 100%; /* Fill height of frame */
            width: auto;  /* Width is dynamic based on time */
            display: block;
        }

        /* CROP OVERLAY (Shadows) */
        .crop-shadow {
            position: absolute;
            top: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); /* Darken area outside crop */
            pointer-events: none; /* Let clicks pass through to scroller */
            transition: width 0.3s;
            z-index: 10;
        }
        #shadow-left { left: 0; width: 0%; border-right: 1px dashed #ff0055; }
        #shadow-right { right: 0; width: 0%; border-left: 1px dashed #ff0055; }

        /* EDITOR CONTROLS (Bottom Panel) */
        .editor-controls { background: #111; padding: 15px; border-top: 1px solid #333; z-index: 20; }
        .control-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .control-row label { color: #00ffcc; font-size: 0.8em; width: 60px; }
        input[type=range] { flex: 1; accent-color: #00ffcc; }
        
        /* Ratio Buttons Mini */
        .ratio-mini-group { display: flex; gap: 5px; flex: 1; }
        .ratio-btn { flex: 1; background: #222; border: 1px solid #444; color: #888; padding: 8px; font-size: 0.7em; cursor: pointer; }
        .ratio-btn.active { background: #ff0055; color: white; border-color: #ff0055; }

        /* LOADING OVERLAY */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; color:#ff0055; backdrop-filter: blur(5px); }
        .loader { border: 4px solid #333; border-top: 4px solid #ff0055; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        video { display: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="loader"></div>
        <div id="overlay-text">BOOTING SYSTEM...</div>
    </div>

    <div id="screen-ingest" class="screen">
        <h1>BAALSAMIC V9</h1>
        
        <div class="config-panel">
            <span class="config-label">Sampling Rate (FPS)</span>
            <div class="radio-group">
                <div class="radio-option"><input type="radio" name="fps" value="15" checked><div class="radio-tile"><span>15</span></div></div>
                <div class="radio-option"><input type="radio" name="fps" value="30"><div class="radio-tile"><span>30</span></div></div>
                <div class="radio-option"><input type="radio" name="fps" value="60"><div class="radio-tile"><span>60</span></div></div>
            </div>

            <span class="config-label">Resolution</span>
            <div class="radio-group">
                <div class="radio-option"><input type="radio" name="res" value="720"><div class="radio-tile"><span>SD</span></div></div>
                <div class="radio-option"><input type="radio" name="res" value="1080"><div class="radio-tile"><span>HD</span></div></div>
                <div class="radio-option"><input type="radio" name="res" value="0" checked><div class="radio-tile"><span>4K</span></div></div>
            </div>
        </div>

        <input type="file" id="upload" accept="video/*" class="upload-input">
        <button class="btn-action" id="btn_stitch">GET STITCHES</button>
    </div>

    <div id="screen-time-travel" class="screen">
        <div class="editor-container">
            
            <div class="viewport-wrapper">
                <div class="teal-frame" id="viewport_frame">
                    
                    <div class="scroll-container" id="scroll_container">
                        <canvas id="main_canvas"></canvas>
                    </div>

                    <div id="shadow-left" class="crop-shadow"></div>
                    <div id="shadow-right" class="crop-shadow"></div>
                </div>
            </div>

            <div class="editor-controls">
                
                <div class="control-row">
                    <label>RATIO</label>
                    <div class="ratio-mini-group">
                        <button class="ratio-btn active" onclick="setRatio('max')">MAX</button>
                        <button class="ratio-btn" onclick="setRatio('1:1')">1:1</button>
                        <button class="ratio-btn" onclick="setRatio('16:9')">16:9</button>
                    </div>
                </div>

                <div class="control-row">
                    <label>WIDTH</label>
                    <input type="range" id="input_width" min="1" max="100" value="20" onchange="triggerUpdate()">
                </div>
                <div class="control-row">
                    <label>JITTER</label>
                    <input type="range" id="input_jitter" min="0" max="50" value="5" onchange="triggerUpdate()">
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn-secondary" onclick="resetApp()">BACK</button>
                    <button class="btn-action" id="btn_render_final">RENDER VIEW</button>
                </div>
            </div>
        </div>
    </div>

    <video id="hidden_video" muted playsinline></video>
    <canvas id="hidden_canvas"></canvas>

    <script>
    // --- UI MANAGER ---
    let currentRatio = 'max';

    function setRatio(r) {
        currentRatio = r;
        document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        updateCropShadows();
    }

    function updateCropShadows() {
        const frame = document.getElementById('viewport_frame');
        const left = document.getElementById('shadow-left');
        const right = document.getElementById('shadow-right');
        
        // Default: No crop
        let cropW = 0; 
        
        if (currentRatio !== 'max') {
            const h = frame.clientHeight;
            let targetW = 0;
            
            if (currentRatio === '1:1') targetW = h;
            if (currentRatio === '16:9') targetW = h * (9/16); // Portrait 9:16 relative to frame
            
            // Calculate percentage of empty space
            const totalW = frame.clientWidth;
            const diff = totalW - targetW;
            if (diff > 0) {
                cropW = (diff / 2) / totalW * 100;
            }
        }

        left.style.width = cropW + "%";
        right.style.width = cropW + "%";
    }

    function resetApp() {
        document.getElementById('screen-time-travel').style.display = 'none';
        document.getElementById('screen-ingest').style.display = 'flex';
    }

    function triggerUpdate() {
        // Debounce or immediate call to Python to re-render using current slider values
        window.call_py("await update_preview()");
    }

    // --- PYODIDE LOADER ---
    const PYODIDE_BASE = "https://cdn.jsdelivr.net/pyodide/v0.23.2/full/";
    
    function setLoading(msg, show=true) {
        const ov = document.getElementById("overlay");
        ov.style.display = show ? "flex" : "none";
        document.getElementById("overlay-text").innerText = msg;
    }

    (function(){
        const s = document.createElement("script");
        s.src = PYODIDE_BASE + "pyodide.js";
        s.onload = async () => {
            try {
                window.pyodide = await loadPyodide({indexURL: PYODIDE_BASE});
                window.call_py = async function(expr){ return await pyodide.runPythonAsync(expr); };
                await initializePython();
            } catch(e){ setLoading("INIT ERROR: " + e); }
        };
        document.head.appendChild(s);
    })();

    async function initializePython(){
        const code = document.getElementById("inline_python").textContent;
        await pyodide.runPythonAsync(code);
        
        // Wire Buttons
        document.getElementById("btn_stitch").onclick = async () => {
            setLoading("LOADING VIDEO...");
            await pyodide.runPythonAsync("await ingest_video()");
        };
        
        document.getElementById("btn_render_final").onclick = async () => {
            setLoading("RENDERING FINAL...");
            // Logic to perform crop/save would go here
            // For now, just save the canvas
            const canvas = document.getElementById("main_canvas");
            const link = document.createElement('a');
            link.download = 'baalsamic_v9.png';
            link.href = canvas.toDataURL();
            link.click();
            setLoading("", false);
        };

        setLoading("", false); // Unlock UI
        
        // Initial Ratio Setup
        window.addEventListener('resize', updateCropShadows);
        updateCropShadows();
    }
    </script>

    <script type="text/python" id="inline_python">
from js import document, console, localStorage, JSON, window, setTimeout
import asyncio, random, math

# --- STATE ---
current_seed = 0

async def ingest_video(*args):
    upload = document.getElementById("upload")
    if not upload.files.length:
        window.alert("Select a video first.")
        document.getElementById("overlay").style.display = "none"
        return
    
    file = upload.files.item(0)
    url = window.URL.createObjectURL(file)
    video = document.getElementById("hidden_video")
    video.src = url

    # Wait for metadata
    while not video.duration or math.isnan(video.duration):
        await asyncio.sleep(0.1)
    
    # Transition to Time Travel Screen
    document.getElementById("screen-ingest").style.display = "none"
    document.getElementById("screen-time-travel").style.display = "flex"
    
    # Initial Render
    global current_seed
    current_seed = random.randint(100, 999)
    await update_preview()
    
    document.getElementById("overlay").style.display = "none"

async def update_preview(*args):
    # Read UI inputs
    width = int(document.getElementById("input_width").value)
    jitter = int(document.getElementById("input_jitter").value)
    fps = int(document.querySelector('input[name="fps"]:checked').value)
    res = int(document.querySelector('input[name="res"]:checked').value)
    
    video = document.getElementById("hidden_video")
    
    # Reuse the single main canvas
    await run_process(video, width, jitter, res, "main_canvas", fps, current_seed)

async def run_process(video_elem, width, jitter, target_height, canvas_id, target_fps, seed):
    canvas = document.getElementById("hidden_canvas")
    ctx = canvas.getContext("2d")
    out_canvas = document.getElementById(canvas_id)
    out_ctx = out_canvas.getContext("2d")
    
    scale = 1.0
    if target_height > 0 and video_elem.videoHeight > target_height:
        scale = target_height / video_elem.videoHeight
    
    w = int(video_elem.videoWidth * scale)
    h = int(video_elem.videoHeight * scale)
    canvas.width = w; canvas.height = h
    
    curr_slit = max(1, int(width * scale))
    curr_jitter = int(jitter * scale)

    duration = video_elem.duration
    step = 1 / target_fps
    total_frames = int(duration * target_fps)
    
    # Resize output canvas to fit TIME
    out_canvas.width = total_frames * curr_slit
    out_canvas.height = h
    
    current_time = 0.0
    x_pos = 0
    random.seed(seed)
    
    while current_time < duration:
        video_elem.currentTime = current_time
        await asyncio.sleep(0.02) # Fast seek
        try: ctx.drawImage(video_elem, 0, 0, w, h)
        except: break
        
        offset = random.randint(-curr_jitter, curr_jitter)
        center_x = (w // 2) + offset
        start_x = max(0, min(w - curr_slit, center_x))
        
        try: out_ctx.drawImage(canvas, start_x, 0, curr_slit, h, x_pos, 0, curr_slit, h)
        except: break
        
        current_time += step
        x_pos += curr_slit
        
        if x_pos % 200 == 0: await asyncio.sleep(0.001)

    </script>
</body>
</html>
